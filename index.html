<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="author" content="Rafa Robles Fontanet">
    <meta name="copyright" content="Rafa Robles Fontanet 2026">
    <meta name="license" content="CC BY-NC-SA 4.0">
    <meta name="description" content="Generador de pictogrames pluriling√ºe amb traducci√≥ autom√†tica intel¬∑ligent.">

    <title>Generador de Pictogrames Pluriling√ºe</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Andika&family=Dancing+Script:wght@400;700&family=Fredoka:wght@400;600&family=Indie+Flower&family=Patrick+Hand&family=Roboto&display=swap" rel="stylesheet">
    
    <style>
        /* --- ESTILS GENERALS --- */
        :root {
            --color-fons: #f0f8ff;
            --color-principal: #4a90e2;
            --color-secundari: #f39c12; 
            --color-accio: #27ae60;
            --mida-font-base: 18px; 
            --tipus-font: 'Arial', sans-serif;
            --color-font: #000000;
            --num-columnes: 3;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: var(--color-fons);
            margin: 0; padding: 20px;
        }

        /* CONFIGURACI√ì */
        .configuracio {
            background-color: white; padding: 25px; border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); max-width: 900px;
            margin: 0 auto 20px auto; border-left: 10px solid var(--color-principal);
        }

        h1 { color: #2c3e50; text-align: center; margin-top: 0; font-size: 1.8em; }
        
        .fila-flex { display: flex; gap: 20px; margin-bottom: 15px; align-items: flex-end; }
        .columna { flex: 1; }

        label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; font-size: 0.9em; }
        
        input[type="text"], select, textarea {
            width: 100%; padding: 10px; border: 2px solid #ddd;
            border-radius: 8px; font-size: 16px; box-sizing: border-box;
        }

        /* CHECKBOXES IDIOMES */
        .selector-idiomes-wrapper {
            border: 2px solid #ddd; border-radius: 8px; padding: 10px;
            max-height: 150px; overflow-y: auto; background: #fafafa;
            display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 5px;
        }
        .opcio-idioma { display: flex; align-items: center; gap: 5px; font-size: 0.85em; cursor: pointer; }
        .opcio-idioma input { width: auto; cursor: pointer; }
        .limit-info { font-size: 0.8em; color: var(--color-principal); margin-top: 5px; font-style: italic; }

        /* ESTIL BOT√ì LOGO */
        .input-logo-wrapper {
            border: 2px dashed #ccc; padding: 8px; border-radius: 8px; 
            text-align: center; cursor: pointer; transition: all 0.3s;
            background: #fafafa; font-size: 0.9em; color: #777;
        }
        .input-logo-wrapper:hover { border-color: var(--color-principal); color: var(--color-principal); }
        .input-logo-wrapper.feteservir {
            border-style: solid; border-color: var(--color-accio); 
            background-color: #e8f8f5; color: var(--color-accio); font-weight: bold;
        }

        /* BARRA D'EINES */
        .barra-estils {
            background: #eef2f7; padding: 15px; border-radius: 8px; margin-bottom: 20px;
            border: 1px solid #d1d9e6; 
            display: flex; gap: 15px; align-items: center; justify-content: space-between; flex-wrap: wrap;
        }
        .control-estil { display: flex; flex-direction: column; min-width: 90px; }
        input[type="color"] { border: none; width: 100%; height: 40px; cursor: pointer; background: none; }
        textarea { height: 80px; resize: vertical; }

        /* BOTONS */
        .btn-container { display: flex; gap: 10px; margin-top: 20px; }
        button {
            border: none; padding: 12px 25px; font-size: 16px; border-radius: 50px;
            cursor: pointer; font-weight: bold; color: white;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            transition: transform 0.1s;
        }
        button:active { transform: scale(0.98); }
        .btn-generar { background-color: var(--color-principal); flex: 2; }
        .btn-imprimir { background-color: var(--color-accio); flex: 1; }

        /* --- ZONA D'IMPRESSI√ì --- */
        #zona-impressio {
            background-color: white; padding: 15mm; 
            min-height: 297mm; width: 210mm; 
            margin: 0 auto; box-shadow: 0 0 10px rgba(0,0,0,0.1); 
            box-sizing: border-box; 
        }

        .header-print {
            display: grid; grid-template-columns: 120px 1fr 120px; 
            align-items: center; margin-bottom: 15px; border-bottom: 2px solid #eee; padding-bottom: 10px;
            height: 70px; overflow: hidden;
        }
        .logo-escola { height: 100%; width: auto; max-height: 60px; object-fit: contain; display: none; }
        .titol-print-container { text-align: center; }
        .titol-print-container h2 { margin: 0; font-size: 1.8em; color: #222; }
        .curs-print { font-size: 1.2em; font-weight: bold; color: #555; text-align: right; }

        /* GRAELLA */
        .graella {
            display: grid; grid-template-columns: repeat(var(--num-columnes), 1fr); 
            gap: 15px; width: 100%;
        }

        .zona-revers { display: none; margin-top: 50px; border-top: 2px dashed #ccc; padding-top: 20px; }

        /* --- DISSENY DE LA TARGETA --- */
        .pictograma {
            border: 3px solid #000; border-radius: 15px; background: white; 
            display: flex; flex-direction: column; align-items: center; justify-content: space-between; 
            aspect-ratio: 0.85; padding: 10px; cursor: grab; 
            break-inside: avoid; page-break-inside: avoid; box-sizing: border-box; position: relative;
        }
        .pictograma:hover { box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .pictograma.dragging { opacity: 0.4; border: 3px dashed #999; background: #eee; }

        .pictograma img {
            width: 100%; height: 65%; object-fit: contain; pointer-events: none;
        }

        .text-container {
            height: 35%; width: 100%; display: flex; 
            align-items: center; justify-content: center; text-align: center;
        }

        .text-line {
            font-family: var(--tipus-font); color: var(--color-font);
            line-height: 1.1; font-weight: bold;
        }

        /* --- MODES DE VISUALITZACI√ì --- */

        /* MODE 1: IMATGE + TEXT (STANDARD) */
        .mode-standard .pictograma img { height: 65%; }
        .mode-standard .text-container { 
            flex-direction: row; flex-wrap: wrap; gap: 5px; align-content: center;
        }
        .mode-standard .text-line {
            font-size: var(--mida-font-base);
            /* Intentem que no trenqui la l√≠nia si √©s curt */
            white-space: nowrap; 
        }
        /* Si es fa molt llarg i surt del contenidor, permetem trencar */
        @media print { .mode-standard .text-line { white-space: normal; } }
        
        /* Separador visual */
        .mode-standard .text-line:not(:last-child)::after {
            content: " / "; color: #999;
        }

        /* MODE 2: TARGETA (FRONT) - NOM√âS IMATGE */
        .mode-targeta-front .pictograma img { height: 100%; }
        .mode-targeta-front .text-container { display: none !important; }

        /* MODE 3: TARGETA (BACK) - NOM√âS TEXT (LLISTA) */
        .mode-targeta-back .pictograma img { display: none; }
        .mode-targeta-back .text-container { 
            height: 100%; flex-direction: column; gap: 15px; 
        }
        .mode-targeta-back .text-line { font-size: calc(var(--mida-font-base) * 1.5); white-space: normal; }
        .mode-targeta-back .text-line::after { content: ""; }

        /* MODAL */
        #modal-edicio { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; justify-content: center; align-items: center; }
        .modal-contingut { background: white; border-radius: 12px; width: 90%; max-width: 650px; display: flex; flex-direction: column; max-height: 90vh; overflow: hidden; }
        .modal-tabs { display: flex; background: #f1f1f1; border-bottom: 1px solid #ddd; }
        .tab-btn { flex: 1; padding: 12px; border: none; background: none; cursor: pointer; font-weight: bold; color: #555; border-bottom: 3px solid transparent; }
        .tab-btn.actiu { border-bottom: 3px solid var(--color-principal); color: var(--color-principal); background: white; }
        .modal-body { padding: 25px; overflow-y: auto; }
        .grup-titol-modal { margin-bottom: 20px; text-align: center; display: flex; flex-direction: column; gap: 10px; }
        .nom-editable { width: 100%; font-size: 1.3em; font-weight: bold; text-align: center; border: 2px solid #eee; border-radius: 8px; padding: 8px; box-sizing: border-box; }
        
        .cerca-wrapper { display: flex; gap: 8px; margin-bottom: 15px; }
        .btn-cerca-modal { background: var(--color-principal); border-radius: 8px; padding: 10px 20px; font-size: 1em; flex-shrink: 0; color: white; border: none; cursor: pointer; }
        .resultats-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 10px; margin-top: 15px; }
        .resultats-grid img { width: 100%; height: 90px; object-fit: contain; border: 1px solid #eee; border-radius: 8px; cursor: pointer; padding: 5px; }

        /* IMPRESSI√ì */
        @media print {
            @page { size: A4 portrait; margin: 0 !important; }
            body { background: white; padding: 0; margin: 0; -webkit-print-color-adjust: exact; }
            .configuracio, .no-print, #modal-edicio { display: none !important; }
            #zona-impressio { padding: 15mm; width: 100%; max-width: 210mm; margin: 0 auto; box-shadow: none; }
            .graella { gap: 8px; }
            .pictograma { border: 3px solid #000; }
            
            .zona-revers {
                padding-top: 15mm !important; margin-top: 0 !important; border: none !important;
                page-break-before: always; direction: rtl; display: block !important;
            }
            /* Ocultar revers si mode standard */
            .mode-standard + #contenidor-revers-wrapper { display: none !important; }
        }

        @media screen and (max-width: 850px) {
            .configuracio { width: auto; margin: 10px; padding: 15px; }
            .fila-flex { flex-direction: column; align-items: stretch; gap: 10px; }
            .columna, .control-estil { width: 100%; flex: auto !important; }
            #zona-impressio { width: 100%; padding: 10px; box-sizing: border-box; height: auto; min-height: 50vh; }
            body { padding: 0; background-color: #f0f8ff; }
            .graella { gap: 5px; }
        }
    </style>
</head>
<body>

    <div class="configuracio">
        <h1>Generador de Pictogrames Pluriling√ºe</h1>
        
        <div class="fila-flex">
            <div class="columna" style="flex: 0.6;">
                <label>Logo Escola:</label>
                <div id="wrapper-logo" class="input-logo-wrapper" onclick="document.getElementById('input-logo').click()">
                    üìÅ Pujar Logo
                </div>
                <input type="file" id="input-logo" accept="image/*" style="display:none" onchange="carregarLogo(this)">
            </div>
            <div class="columna" style="flex: 1.5;">
                <label>T√≠tol:</label>
                <input type="text" id="titol-doc" placeholder="Ex: Els animals">
            </div>
            <div class="columna">
                <label>Curs:</label>
                <input type="text" id="curs" placeholder="Ex: 3r A">
            </div>
        </div>
        
        <div style="margin-bottom: 20px;">
            <label>Selecciona els idiomes (Traducci√≥ fiable ARASAAC + IA):</label>
            <div class="selector-idiomes-wrapper" id="contenidor-idiomes"></div>
            <div id="msg-limit" class="limit-info"></div>
        </div>

        <div class="barra-estils">
            <div class="control-estil" style="flex:1;">
                <label>M√®tode</label>
                <select id="selector-mode" onchange="canviarMode()">
                    <option value="standard">Imatge + Text (M√†x 2 idiomes)</option>
                    <option value="targeta">Targeta Doble Cara (M√†x 5 idiomes)</option>
                </select>
            </div>
            <div class="control-estil" style="flex:1;">
                <label>Mida / Columnes</label>
                <select id="selector-columnes" onchange="actualitzarEstils()">
                    <option value="1">1 (Gegant)</option>
                    <option value="2">2 (Molt Gran)</option>
                    <option value="3" selected>3 (Gran)</option>
                    <option value="4">4 (Mitjana)</option>
                    <option value="5">5 (Petita - A4)</option>
                </select>
            </div>
            <div class="control-estil" style="flex:1;">
                <label>Font</label>
                <select id="selector-font" onchange="actualitzarEstils()">
                    <option value="'Arial', sans-serif">Arial</option>
                    <option value="'Fredoka', sans-serif">Fredoka (Rodona)</option>
                    <option value="'Patrick Hand', cursive">Manual</option>
                    <option value="'Dancing Script', cursive">Lligada</option>
                    <option value="'Andika', sans-serif">Lectoescriptura</option>
                </select>
            </div>
            <div class="control-estil" style="flex:0.8;">
                <label>Mida Lletra</label>
                <input type="range" id="selector-mida" min="12" max="30" value="18" oninput="actualitzarEstils()">
            </div>
        </div>

        <div class="grup-input">
            <label>Llista de paraules en Catal√† (separa-les per comes):</label>
            <textarea id="llista-paraules" placeholder="Ex: maduixa, pl√†tan, llimona..."></textarea>
        </div>

        <div class="btn-container">
            <button class="btn-generar" onclick="generarDocument()">‚ö° Generar i Traduir</button>
            <button class="btn-imprimir" onclick="window.print()">üñ®Ô∏è Imprimir</button>
        </div>
        <p class="no-print" style="text-align:center; color:#e74c3c; font-size:0.85em; margin-top:15px; margin-bottom:0;">
            * A imprimir, desmarca "Cap√ßaleres i peus de p√†gina" a "M√©s opcions".
        </p>
    </div>

    <div id="zona-impressio">
        <div class="header-print">
            <div style="display:flex; justify-content:flex-start;"><img id="logo-visual" class="logo-escola" src="" alt="Logo"></div>
            <div class="titol-print-container"><h2 id="titol-resultat">T√≠tol del document</h2></div>
            <div class="curs-print"><span id="curs-resultat"></span></div>
        </div>
        <div class="graella" id="contenidor-picts"></div>

        <div id="contenidor-revers-wrapper" class="zona-revers">
            <div class="header-print" style="direction: ltr;">
                <div style="display:flex; justify-content:flex-start;"><img id="logo-visual-back" class="logo-escola" src="" alt="Logo"></div>
                <div class="titol-print-container"><h2 id="titol-resultat-back">T√≠tol del document</h2></div>
                <div class="curs-print"><span id="curs-resultat-back"></span></div>
            </div>
            <div class="graella" id="contenidor-revers"></div>
        </div>
    </div>

    <div class="no-print" style="text-align: center; margin-top: 40px; padding: 20px; font-size: 0.8em; color: #666; border-top: 1px solid #eee;">
        <p style="margin: 0;">Creat per <b>Rafa Robles Fontanet</b> | <b>Escola Pau Picasso</b></p>
        <p style="margin: 5px 0;">
            <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" style="color: #4a90e2; text-decoration: none;">
                <img alt="Llic√®ncia de Creative Commons" style="border-width:0; vertical-align: middle;" src="https://i.creativecommons.org/l/by-nc-sa/4.0/80x15.png" />
                <br />CC BY-NC-SA 4.0
            </a>
        </p>
    </div>

    <div id="modal-edicio">
        <div class="modal-contingut">
            <div class="modal-tabs">
                <button class="tab-btn actiu" onclick="canviarPestanya('tab-arasaac')">üß© ARASAAC</button>
                <button class="tab-btn" onclick="canviarPestanya('tab-wiki')">üì∑ Wiki</button>
                <button class="tab-btn" onclick="canviarPestanya('tab-simbols')">‚úíÔ∏è S√≠mbols</button>
                <button class="tab-btn" onclick="canviarPestanya('tab-pujar')">üì§ Pujar/IA</button>
            </div>
            <div class="modal-body">
                <div class="grup-titol-modal" id="modal-inputs-idiomes"></div>
                <div id="tab-arasaac" class="contingut-tab">
                    <div class="cerca-wrapper"><input id="input-arasaac" onkeyup="if(event.key==='Enter') buscarArasaacModal()"><button class="btn-cerca-modal" onclick="buscarArasaacModal()">üîç Cerca</button></div>
                    <div id="resultats-arasaac" class="resultats-grid"></div>
                </div>
                <div id="tab-wiki" class="contingut-tab" style="display:none;">
                    <div class="cerca-wrapper"><input id="input-wiki" onkeyup="if(event.key==='Enter') buscarWikiImages()"><button class="btn-cerca-modal btn-cerca-wiki" onclick="buscarWikiImages()">üì∑ Cerca</button></div>
                    <div id="resultats-wiki" class="resultats-grid"></div>
                </div>
                <div id="tab-simbols" class="contingut-tab" style="display:none;">
                    <div class="cerca-wrapper"><input id="input-open" onkeyup="if(event.key==='Enter') buscarOpenSymbols()"><button class="btn-cerca-modal btn-cerca-open" onclick="buscarOpenSymbols()">‚úíÔ∏è Cerca</button></div>
                    <div id="resultats-open" class="resultats-grid"></div>
                </div>
                <div id="tab-pujar" class="contingut-tab" style="display:none;text-align:center;">
                    <p>Puja una imatge pr√≤pia:</p><input type="file" accept="image/*" onchange="pujarImatge(this)">
                    <hr style="margin:20px 0; border:0; border-top:1px solid #eee;">
                    <button onclick="window.open('https://www.craiyon.com/','_blank','width=400,height=600')" style="background:#333;color:white;margin:auto;padding:15px;border-radius:50px;">üé® Generar amb IA</button>
                </div>
            </div>
            <div style="padding:15px;background:#f9f9f9;text-align:right;">
                <button onclick="guardarTancar()" style="background:var(--color-accio);display:inline-flex;">‚úÖ Fet</button>
                <button onclick="tancarModal()" style="background:#999;display:inline-flex;">Tancar</button>
            </div>
        </div>
    </div>

    <script>
        // CONFIGURACI√ì IDIOMES I SUPORT ARASAAC
        // 'arasaac: true' vol dir que ARASAAC t√© la traducci√≥ nativa. 'false' vol dir que hem de traduir via API.
        const llistatIdiomes = [
            { codi: 'ca', nom: 'Catal√†', RTL: false, arasaac: true },
            { codi: 'es', nom: 'Castell√†', RTL: false, arasaac: true },
            { codi: 'en', nom: 'Angl√®s', RTL: false, arasaac: true },
            { codi: 'fr', nom: 'Franc√®s', RTL: false, arasaac: true },
            { codi: 'it', nom: 'Itali√†', RTL: false, arasaac: true },
            { codi: 'pt', nom: 'Portugu√®s', RTL: false, arasaac: true },
            { codi: 'de', nom: 'Alemany', RTL: false, arasaac: true },
            { codi: 'uk', nom: 'Ucra√Øn√®s', RTL: false, arasaac: false }, // ARASAAC no sol tenir UK
            { codi: 'ro', nom: 'Roman√®s', RTL: false, arasaac: true },
            { codi: 'ru', nom: 'Rus', RTL: false, arasaac: true },
            { codi: 'ar', nom: '√Ärab', RTL: true, arasaac: true },
            { codi: 'zh-CN', nom: 'Xin√®s', RTL: false, arasaac: true },
            { codi: 'ur', nom: 'Urd√∫', RTL: true, arasaac: false },
            { codi: 'pa', nom: 'Panjabi', RTL: false, arasaac: false }
        ];

        let elementEditant = null;
        let limitSeleccio = 2; 

        window.onload = function() {
            generarSelectorIdiomes();
            canviarMode();
        };

        function generarSelectorIdiomes() {
            const cont = document.getElementById('contenidor-idiomes');
            llistatIdiomes.forEach(lang => {
                const div = document.createElement('div');
                div.className = 'opcio-idioma';
                const chk = document.createElement('input');
                chk.type = 'checkbox';
                chk.value = lang.codi;
                chk.dataset.nom = lang.nom;
                chk.dataset.rtl = lang.RTL;
                chk.dataset.arasaac = lang.arasaac;
                
                if (lang.codi === 'ca') chk.checked = true; 
                chk.addEventListener('change', controlarLimit);

                const lbl = document.createElement('span');
                lbl.innerText = lang.nom;
                lbl.onclick = () => { chk.checked = !chk.checked; controlarLimit({target: chk}); };

                div.appendChild(chk); div.appendChild(lbl); cont.appendChild(div);
            });
        }

        function canviarMode() {
            const mode = document.getElementById('selector-mode').value;
            const msg = document.getElementById('msg-limit');
            limitSeleccio = (mode === 'standard') ? 2 : 5;
            msg.innerText = mode === 'standard' ? "Mode 'Imatge + Text': M√†xim 2 idiomes." : "Mode 'Targeta': M√†xim 5 idiomes.";
            
            const checked = document.querySelectorAll('.opcio-idioma input:checked');
            if (checked.length > limitSeleccio) {
                alert(`Has canviat de mode. Es desmarcaran els idiomes sobrants.`);
                for(let i=limitSeleccio; i<checked.length; i++) checked[i].checked = false;
            }
        }

        function controlarLimit(e) {
            const checked = document.querySelectorAll('.opcio-idioma input:checked');
            if (checked.length > limitSeleccio) {
                e.target.checked = false;
                alert(`Nom√©s pots seleccionar ${limitSeleccio} idiomes en aquest mode.`);
            }
        }

        function obtenirIdiomesSeleccionats() {
            const checked = document.querySelectorAll('.opcio-idioma input:checked');
            const llista = [];
            checked.forEach(c => llista.push({ 
                codi: c.value, 
                nom: c.dataset.nom, 
                rtl: c.dataset.rtl === 'true',
                arasaac: c.dataset.arasaac === 'true'
            }));
            return llista;
        }

        // --- TRADUCTOR ---
        async function traduirExternament(text, codiDesti) {
            if (codiDesti === 'ca') return text; 
            try {
                // Utilitzem MyMemory, per√≤ si falle, no posar√† coses rares com Chirlas si tradu√Øm des de l'Angl√®s
                // PER√í per ser segurs, primer confiem en ARASAAC si podem. Si no, API.
                const res = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=ca|${codiDesti}`);
                const data = await res.json();
                if(data.responseData && data.responseData.translatedText) {
                    return data.responseData.translatedText;
                }
                return text; 
            } catch (e) { return text; }
        }

        // GENERACI√ì
        async function generarDocument() {
            const titol = document.getElementById('titol-doc').value || "Sense t√≠tol";
            const curs = document.getElementById('curs').value;
            const textParaules = document.getElementById('llista-paraules').value;
            const mode = document.getElementById('selector-mode').value;
            
            // UI Update
            document.getElementById('titol-resultat').innerText = titol;
            document.getElementById('titol-resultat-back').innerText = titol;
            const cursEl = document.getElementById('curs-resultat');
            const cursElBack = document.getElementById('curs-resultat-back');
            if (curs.trim()) { 
                cursEl.innerText = curs; cursEl.style.display='block'; 
                cursElBack.innerText = curs; cursElBack.style.display='block';
            } else { 
                cursEl.style.display='none'; cursElBack.style.display='none';
            }

            const contenidor = document.getElementById('contenidor-picts');
            const contenidorRevers = document.getElementById('contenidor-revers');
            const wrapperRevers = document.getElementById('contenidor-revers-wrapper');

            contenidor.innerHTML = '';
            contenidorRevers.innerHTML = '';

            const idiomesActius = obtenirIdiomesSeleccionats();
            if (idiomesActius.length === 0) return alert("Selecciona un idioma!");

            if (mode === 'targeta') {
                wrapperRevers.style.display = 'block';
                contenidor.className = 'graella mode-targeta-front'; 
                contenidorRevers.className = 'graella mode-targeta-back';
            } else {
                wrapperRevers.style.display = 'none';
                contenidor.className = 'graella mode-standard';
                contenidorRevers.className = 'graella';
            }

            if (!textParaules.trim()) return; 
            const llista = textParaules.split(',').map(p=>p.trim()).filter(p=>p!=='');
            
            // PROCESSAMENT
            for (let i = 0; i < llista.length; i++) {
                let paraulaBase = llista[i]; // Catal√†
                
                // Creem estructura inicial (placeholder mentre carrega)
                let textos = {};
                idiomesActius.forEach(l => textos[l.nom] = "...");

                // DOM
                const divFront = crearTargetaDOM(i, 'front', textos, idiomesActius);
                contenidor.appendChild(divFront);

                if (mode === 'targeta') {
                    const divBack = crearTargetaDOM(i, 'back', textos, idiomesActius);
                    contenidorRevers.appendChild(divBack);
                }
                
                // CRIDA INTEL¬∑LIGENT (ARASAAC + TRADUCCI√ì)
                processarParaulaSmart(paraulaBase, i, idiomesActius);
            }
            actualitzarEstils();
        }

        async function processarParaulaSmart(paraula, index, idiomes) {
            // 1. Busquem l'ID a ARASAAC (en Catal√†)
            try {
                const rSearch = await fetch(`https://api.arasaac.org/api/pictograms/ca/search/${encodeURIComponent(paraula)}`);
                const dSearch = await rSearch.json();

                if (dSearch.length > 0) {
                    const idPic = dSearch[0]._id;
                    const imgSrc = `https://static.arasaac.org/pictograms/${idPic}/${idPic}_500.png`;
                    actualitzarImatges(index, imgSrc, "1");

                    // 2. Obtenim detalls per veure si tenim traduccions oficials
                    const rDetalls = await fetch(`https://api.arasaac.org/api/pictograms/${idPic}`);
                    const dDetalls = await rDetalls.json(); // Aqu√≠ hi ha les keywords en molts idiomes

                    // 3. Omplim els textos
                    for (let lang of idiomes) {
                        let textFinal = "";
                        
                        // CAS A: √âs Catal√† (ja el tenim)
                        if (lang.codi === 'ca') {
                            textFinal = paraula.charAt(0).toUpperCase() + paraula.slice(1);
                        }
                        // CAS B: ARASAAC t√© l'idioma oficialment
                        else if (lang.arasaac) {
                            // Busquem a keywords
                            // Nota: dDetalls.keywords √©s un array d'objectes. Volem el primer match.
                            /* Estructura keywords: [{keyword: "cat", locale: "en"}, ...] */
                            const match = dDetalls.keywords.find(k => k.locale === lang.codi);
                            if (match) {
                                textFinal = match.keyword;
                                textFinal = textFinal.charAt(0).toUpperCase() + textFinal.slice(1);
                            } else {
                                // Fallback a traductor si ARASAAC diu que suporta per√≤ no t√© aquesta paraula
                                textFinal = await traduirExternament(paraula, lang.codi);
                            }
                        }
                        // CAS C: ARASAAC no suporta (Urd√∫, Panjabi...) -> TRADUIR DES DE L'ANGL√àS
                        else {
                            // Truc: Agafem la paraula en Angl√®s d'ARASAAC per tenir millor traducci√≥
                            const matchEn = dDetalls.keywords.find(k => k.locale === 'en');
                            const baseText = matchEn ? matchEn.keyword : paraula; // Si no tenim EN, usem CA
                            textFinal = await traduirExternament(baseText, lang.codi);
                            // Capitalitzem
                            textFinal = textFinal.charAt(0).toUpperCase() + textFinal.slice(1);
                        }

                        actualitzarText(index, lang.nom, textFinal);
                    }

                } else {
                    // No trobat a ARASAAC
                    actualitzarImatges(index, "https://static.arasaac.org/images/no_results.png", "0.3");
                    // Intentem traduir igualment el text base
                    for (let lang of idiomes) {
                        let t = await traduirExternament(paraula, lang.codi);
                        actualitzarText(index, lang.nom, t);
                    }
                }

            } catch (e) { console.error(e); }
        }

        function crearTargetaDOM(index, tipus, textos, idiomes) {
            const div = document.createElement('div');
            div.className = 'pictograma';
            div.draggable = true; 
            div.dataset.index = index; 
            
            div.addEventListener('click', () => { if(!div.classList.contains('dragging') && tipus === 'front') obrirModal(div); });
            div.addEventListener('dragstart', () => { div.classList.add('dragging'); });
            div.addEventListener('dragend', () => { div.classList.remove('dragging'); });

            const img = document.createElement('img');
            img.id = `img-${index}-${tipus}`; 
            img.src = 'https://upload.wikimedia.org/wikipedia/commons/c/ca/1x1.png'; 
            
            const textContainer = document.createElement('div');
            textContainer.className = 'text-container';
            textContainer.id = `txtcont-${index}-${tipus}`;

            idiomes.forEach(lang => {
                const p = document.createElement('span'); 
                p.className = 'text-line';
                p.innerText = textos[lang.nom];
                p.dataset.lang = lang.nom;
                if(lang.rtl) p.style.direction = 'rtl';
                textContainer.appendChild(p);
            });

            div.appendChild(img);
            div.appendChild(textContainer);
            return div;
        }

        function actualitzarImatges(index, src, opacitat) {
            const f = document.getElementById(`img-${index}-front`);
            const b = document.getElementById(`img-${index}-back`);
            if(f) { f.src=src; f.style.opacity=opacitat; }
            if(b) { b.src=src; }
        }

        function actualitzarText(index, nomIdioma, text) {
            ['front', 'back'].forEach(tipus => {
                const c = document.getElementById(`txtcont-${index}-${tipus}`);
                if (c) {
                    c.querySelectorAll('.text-line').forEach(p => {
                        if (p.dataset.lang === nomIdioma) p.innerText = text;
                    });
                }
            });
        }

        function carregarLogo(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) { 
                    const img = document.getElementById('logo-visual');
                    const imgBack = document.getElementById('logo-visual-back');
                    img.src = e.target.result; img.style.display = 'block';
                    imgBack.src = e.target.result; imgBack.style.display = 'block';
                    document.getElementById('wrapper-logo').classList.add('feteservir');
                    document.getElementById('wrapper-logo').innerHTML = "‚úÖ Logo Carregat";
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function actualitzarEstils() {
            const doc = document.documentElement.style;
            doc.setProperty('--tipus-font', document.getElementById('selector-font').value);
            doc.setProperty('--mida-font-base', document.getElementById('selector-mida').value + 'px');
            doc.setProperty('--num-columnes', document.getElementById('selector-columnes').value);
        }

        // MODAL
        function obrirModal(el) {
            elementEditant = el;
            const index = el.dataset.index;
            const idiomesActius = obtenirIdiomesSeleccionats();
            const containerInputs = document.getElementById('modal-inputs-idiomes');
            containerInputs.innerHTML = '';
            
            idiomesActius.forEach(lang => {
                const containerTxt = document.getElementById(`txtcont-${index}-front`);
                let textActual = "";
                // Busquem el text, per√≤ compte que al front pot estar amagat si √©s mode targeta
                // millor mirar al back si estem en mode targeta, o al front si standard
                let fontText = document.getElementById(`txtcont-${index}-back`) || document.getElementById(`txtcont-${index}-front`);
                
                fontText.querySelectorAll('.text-line').forEach(p => {
                    if(p.dataset.lang === lang.nom) textActual = p.innerText;
                });

                const div = document.createElement('div');
                const lbl = document.createElement('label');
                lbl.innerText = lang.nom;
                lbl.style.color = "#4a90e2"; lbl.style.fontSize="0.8em";
                
                const inp = document.createElement('input');
                inp.type = "text"; inp.value = textActual; inp.dataset.lang = lang.nom;
                inp.className = "nom-editable";
                if(lang.rtl) inp.style.direction = "rtl";

                div.appendChild(lbl); div.appendChild(inp); containerInputs.appendChild(div);
            });

            // Set Inputs cerca
            const primerInput = containerInputs.querySelector('input');
            if(primerInput) {
                const val = primerInput.value;
                document.getElementById('input-arasaac').value = val;
                document.getElementById('input-wiki').value = val;
                document.getElementById('input-open').value = val;
            }

            document.getElementById('modal-edicio').style.display = 'flex';
            canviarPestanya('tab-arasaac'); buscarArasaacModal();
        }

        function guardarTancar() {
            if(elementEditant) {
                const index = elementEditant.dataset.index;
                const inputs = document.querySelectorAll('#modal-inputs-idiomes input');
                inputs.forEach(inp => actualitzarText(index, inp.dataset.lang, inp.value));
            }
            tancarModal();
        }
        function tancarModal() { document.getElementById('modal-edicio').style.display = 'none'; elementEditant=null; }

        function canviarPestanya(id) {
            document.querySelectorAll('.contingut-tab').forEach(e=>e.style.display='none');
            document.querySelectorAll('.tab-btn').forEach(e=>e.classList.remove('actiu'));
            document.getElementById(id).style.display='block';
            const map = {'tab-arasaac':0, 'tab-wiki':1, 'tab-simbols':2, 'tab-pujar':3};
            document.querySelectorAll('.tab-btn')[map[id]].classList.add('actiu');
        }
        function aplicarImatge(src) { 
            if(elementEditant) actualitzarImatges(elementEditant.dataset.index, src, '1');
        }
        async function buscarArasaacModal() {
            const q = document.getElementById('input-arasaac').value;
            renderResultats(await fetch(`https://api.arasaac.org/api/pictograms/ca/search/${encodeURIComponent(q)}`).then(r=>r.json()).then(d=>d.map(x=>`https://static.arasaac.org/pictograms/${x._id}/${x._id}_300.png`)), 'resultats-arasaac');
        }
        async function buscarWikiImages() {
            const q = document.getElementById('input-wiki').value;
            const r = await fetch(`https://ca.wikipedia.org/w/api.php?action=query&generator=search&gsrsearch=${encodeURIComponent(q)}&gsrnamespace=0&gsrlimit=10&prop=pageimages&piprop=thumbnail&pithumbsize=300&format=json&origin=*`).then(res=>res.json());
            const urls = r.query?.pages ? Object.values(r.query.pages).filter(p=>p.thumbnail).map(p=>p.thumbnail.source) : [];
            renderResultats(urls, 'resultats-wiki');
        }
        async function buscarOpenSymbols() {
             const q = document.getElementById('input-open').value;
             const d = await fetch(`https://www.opensymbols.org/api/v1/symbols/search?q=${encodeURIComponent(q)}`).then(r=>r.json());
             renderResultats(d.slice(0,12).map(x=>x.image_url), 'resultats-open');
        }
        function renderResultats(urls, divId) {
            const div = document.getElementById(divId); div.innerHTML='';
            if(!urls || !urls.length) { div.innerHTML='<p style="text-align:center;color:#999">Cap resultat trobat.</p>'; return; }
            urls.forEach(u => { const i = document.createElement('img'); i.src=u; i.onclick=()=>aplicarImatge(u); div.appendChild(i); });
        }
        function pujarImatge(i) {
            const r = new FileReader(); r.onload=e=>aplicarImatge(e.target.result); if(i.files[0]) r.readAsDataURL(i.files[0]);
        }
    </script>
</body>
</html>
